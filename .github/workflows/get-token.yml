name: Get Xiaomi Token

permissions:
  # 方案C：更新到私有 Gist。此处不再需要写仓库内容权限，保留默认最小权限。
  contents: read

on:
  schedule:
    # 测试模式: 每分钟运行一次, 连续运行3次用于验证
    - cron: '* * * * *'
    # 部署时改为: 每12小时运行一次
    # - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  get-token:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Use official npm registry
        run: npm config set registry https://registry.npmjs.org/
      
      - name: Install dependencies
        run: npm install
      
      - name: Get Xiaomi Token
        env:
          XIAOMI_ACCOUNT: ${{ secrets.XIAOMI_ACCOUNT }}
          XIAOMI_PASSWORD: ${{ secrets.XIAOMI_PASSWORD }}
        run: node get_xiaomi_token.js
      
      - name: Check success count
        id: check_success
        run: |
          # 检查最近3次运行是否都成功
          # 读取 token 文件验证是否有效
          if [ -f xiaomi_token.json ]; then
            echo "✓ Token 文件已生成"
            # 检查文件内容是否有效
            if grep -q "serviceToken" xiaomi_token.json && grep -q "userId" xiaomi_token.json; then
              echo "✓ Token 内容有效"
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "✗ Token 内容无效"
              echo "success=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "✗ Token 文件未生成"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Update token to private Gist
        if: steps.check_success.outputs.success == 'true'
        env:
          # 你的私有 Gist ID（例如：a1b2c3d4e5f6...）
          XIAOMI_TOKEN_GIST_ID: ${{ secrets.XIAOMI_TOKEN_GIST_ID }}
          # 具有 gist 权限的 GitHub PAT（建议最小化权限：只勾选 gist）
          XIAOMI_TOKEN_GIST_TOKEN: ${{ secrets.XIAOMI_TOKEN_GIST_TOKEN }}
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const https = require('https');

          const gistId = process.env.XIAOMI_TOKEN_GIST_ID;
          const token = process.env.XIAOMI_TOKEN_GIST_TOKEN;
          if (!gistId || !token) {
            console.error('缺少 Secrets：XIAOMI_TOKEN_GIST_ID 或 XIAOMI_TOKEN_GIST_TOKEN');
            process.exit(1);
          }

          const content = fs.readFileSync('xiaomi_token.json', 'utf8');
          const payload = JSON.stringify({
            files: {
              'xiaomi_token.json': { content },
            },
          });

          const req = https.request(
            {
              method: 'PATCH',
              hostname: 'api.github.com',
              path: `/gists/${gistId}`,
              headers: {
                'User-Agent': 'xiaoai-tts-news',
                Authorization: `token ${token}`,
                Accept: 'application/vnd.github+json',
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(payload),
              },
            },
            (res) => {
              let data = '';
              res.on('data', (chunk) => (data += chunk));
              res.on('end', () => {
                if (res.statusCode && res.statusCode >= 200 && res.statusCode < 300) {
                  console.log('✅ 已更新私有 Gist 中的 xiaomi_token.json');
                } else {
                  console.error(`❌ 更新 Gist 失败：HTTP ${res.statusCode}`);
                  console.error(data);
                  process.exit(1);
                }
              });
            }
          );

          req.on('error', (err) => {
            console.error('❌ 请求 Gist API 出错：', err);
            process.exit(1);
          });

          req.write(payload);
          req.end();
          NODE
